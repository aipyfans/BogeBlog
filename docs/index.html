<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />




<script data-ad-client="ca-pub-7376123380604387" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>











  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="静水流深" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="为了梦-追梦,我的英文名由此而来">
<meta property="og:type" content="website">
<meta property="og:title" content="静水流深">
<meta property="og:url" content="http://blog.lijunbo.com/index.html">
<meta property="og:site_name" content="静水流深">
<meta property="og:description" content="为了梦-追梦,我的英文名由此而来">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="静水流深">
<meta name="twitter:description" content="为了梦-追梦,我的英文名由此而来">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.lijunbo.com/"/>





  <title> 静水流深 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4a874f383236eb548cfc14b4365008b8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">静水流深</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">非淡泊无以明志，非宁静无以致远</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/08/03/plugin_error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/03/plugin_error/" itemprop="url">
                  Android Studio PluginManager$StartupAbortedException 异常解决方案(Mac平台)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-03T22:11:00+08:00">
                2018-08-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/08/03/plugin_error/" class="leancloud_visitors" data-flag-title="Android Studio PluginManager$StartupAbortedException 异常解决方案(Mac平台)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是自己亲自动手解决的首个 Android Studio 异常，网上的方案大都是人云亦云，没有自己的思考</p>
<blockquote>
<p><a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/360000125550-Android-Studio-3-0-1-won-t-start-up-accidentally-reverted-something-during-an-update-" target="_blank" rel="noopener">java.lang.RuntimeException: com.intellij.ide.plugins.PluginManager$StartupAbortedException: Fatal error initializing</a> </p>
</blockquote>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>我们从上面的异常名称来分析一下：</p>
<p><code>PluginManager$StartupAbortedException</code> 见名知意：由于<code>插件管理</code>导致的启动终止</p>
<ol>
<li>最近有没有添加一些新的插件？</li>
<li>有没有异常关机的情况？</li>
</ol>
<h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>既然找到原因了，我们就要动手解决一下：</p>
<ol>
<li>暴力方案：找到插件所在的文件夹，将整个插件文件夹删除</li>
<li>优雅方案：知道自己最近安装了哪些插件，删除指定的插件</li>
</ol>
<blockquote>
<p>出现此异常大多都是因为我们安装了第三方插件导致的不兼容异常</p>
</blockquote>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><ol>
<li><p>Android Studio 【第三方插件】所在的文件夹路径【出现上面的异常，一般情况下，操作此文件夹】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/william/Library/Application Support/AndroidStudio3.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Android Studio 【内置插件】所在的文件夹路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Applications/Android Studio.app/Contents/plugins</span><br></pre></td></tr></table></figure>
</li>
<li><p>Android Studio IDE 【程序】所在的文件夹路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Applications/Android Studio.app/Contents</span><br></pre></td></tr></table></figure>
</li>
<li><p>Android Studio IDE 【配置】所在的文件夹路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/william/Library/Preferences/AndroidStudio3.1</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/07/30/my-daughter-song/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/30/my-daughter-song/" itemprop="url">
                  写给女儿的歌词-Cover《成都》
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-30T22:11:00+08:00">
                2018-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/diary/" itemprop="url" rel="index">
                    <span itemprop="name">diary</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/07/30/my-daughter-song/" class="leancloud_visitors" data-flag-title="写给女儿的歌词-Cover《成都》">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>让我掉下眼泪的    不止送嫁的酒</p>
<p>让我依依不舍的    不止你的眼眸</p>
<p>余生路要走很久    他攒着你的手</p>
<p>让我心有不甘的    是放手的自由</p>
<p>回忆总是在深夜    忍不住冒出了头</p>
<p>将你稚嫩的温柔    托在我的肩头</p>
<p>在这个温馨的小家里    我一直呵护你</p>
<p>女儿        放不下的        只有你</p>
<p>和我在你儿时的街头走一走    </p>
<p>直到所有的回忆都淡了也别逗留</p>
<p>你会挽着我的衣袖        我想牵着你的小手</p>
<p>笑着向你挥一挥手        坐在等你的家门口    </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/03/lokijs_index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/03/lokijs_index/" itemprop="url">
                  Lokijs 中文文档
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-03T09:12:51+08:00">
                2018-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/03/lokijs_index/" class="leancloud_visitors" data-flag-title="Lokijs 中文文档">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs1_overview/">Home</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs2_index_query/">Indexing and Performance</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs3_query_examples/">Query Examples</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs4_changes_api/">Changes API</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs5_persistence_adapters/">Persistence and Adapters</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs6_collection_transforms/">Collection Transforms</a></li>
<li><a href="https://blog.lijunbo.com/2018/05/02/lokijs7_autoupdating_collections/">Autoupdating Collections</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs4_changes_api/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs4_changes_api/" itemprop="url">
                  API的变化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs4_changes_api/" class="leancloud_visitors" data-flag-title="API的变化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>LokiJS 1.1 introduces a “Changes API” that enables the user to keep track of the changes happened to each collection since a particular point in time, which is usually the start of a work session but it could be a user defined one. This is particularly useful for remote synchronization.</p>
<h2 id="Description-of-the-Changes-API"><a href="#Description-of-the-Changes-API" class="headerlink" title="Description of the Changes API"></a>Description of the Changes API</h2><p>The Changes API is a collection-level feature, hence you can establish which collections may simply contain volatile data and which ones need to keep a record of what has changed.</p>
<p>The Changes API is an optional feature and can be activated/deactivated by either passing the option <code>{ disableChangesApi: isDisabled }</code> in the config parameter of a collection constructor, or by calling <code>collection.setChangesApi(isEnabled)</code>. Note that LokiJS will always set the fastest performing setting as default on a collection or database, hence the Changes API is <strong>disabled</strong> by default.</p>
<p>There are three events which will trigger a Changes API operation: inserts, updates and deletes. When either of these events occur, on a collection with Changes API activated, the collection will store a snapshot of the relevant object, associated with the operation and the name of the collection.</p>
<p>From the database object it is then possible to invoke the <code>serializeChanges</code> method which will generate a string representation of the changes occurred to be used for synchronization purposes.</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>To enable the Changes API make sure to either instantiate a collection using <code>db.addCollection(&#39;users&#39;, { disableChangesApi: false })</code>, or call <code>users.setChangesApi(true)</code> (given an example <code>users</code> collection).</p>
<p>To generate a string representation of the changes, call <code>db.serializeChanges()</code>. This will generate a representation of all the changes for those collections that have the Changes API enabled. If you are only interested in generating changes for a subset of collections, you can pass an array of names of the collections, i.e. <code>db.serializeChanges([&#39;users&#39;]);</code>.</p>
<p>To clear all the changes, call <code>db.clearChanges()</code>. Alternatively you can call <code>flushChanges()</code> on the single collection, normally you would call <code>db.clearChanges()</code> on a callback from a successful synchronization operation.</p>
<p>Each change is an object with three properties: <code>name</code> is the collection name, <code>obj</code> is the string representation of the object and <code>operation</code> is a character representing the operation (“I” for insert, “U” for update, “R” for remove). So for example, inserting user <code>{ name: &#39;joe&#39; }</code> in the users collection would generate a change <code>{ name: &#39;users&#39;, obj: { name: &#39;joe&#39; }, operation: &#39;I&#39; }</code>. Changes are kept in order of how the happened so a 3rd party application will be able to operate insert updates and deletes in the correct order.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs5_persistence_adapters/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs5_persistence_adapters/" itemprop="url">
                  LokiJS 持久化以及适配器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs5_persistence_adapters/" class="leancloud_visitors" data-flag-title="LokiJS 持久化以及适配器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>LokiJS持久化是通过适配器接口实现的。我们支持<code>自动保存</code>和<code>自动加载</code>选项，简单的<code>键/值</code>适配器以及<code>参考模式</code>的适配器，并且现在支持各种结构化序列化方法，可以轻松创建自己的持久化适配器以及批量或流式数据交换。</p>
<p>像<code>lokijs</code>这样的内存数据库和传统数据库系统之间的一个重要区别是，所有文档/记录都保存在内存中，并且不会根据需要加载。因此持久化仅用于<code>保存和恢复</code>这个内存数据库的状态。</p>
<blockquote>
<p>如果您的数据库足够小，并且您希望尝试，则可以调用<code>db.serialize()</code>以返回完整序列化的数据库，并将其加载到另一个数据库实例中，如<code>dbcopy.loadJSON(str)</code>。</p>
</blockquote>
<h1 id="Node-js-快速开始"><a href="#Node-js-快速开始" class="headerlink" title="Node.js 快速开始"></a>Node.js 快速开始</h1><p>If you are using lokijs in a node environment, we will automatically detect and use the built-in LokiFsAdapter without your needing to provide an adapter.</p>
<h3 id="No-Persistence-example-entirely-synchronous-and-in-memory"><a href="#No-Persistence-example-entirely-synchronous-and-in-memory" class="headerlink" title="No Persistence example (entirely synchronous and in memory) :"></a>No Persistence example (entirely synchronous and in memory) :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loki = <span class="built_in">require</span>(<span class="string">"lokijs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> db = <span class="keyword">new</span> loki(<span class="string">"quickstart.db"</span>);</span><br><span class="line"><span class="keyword">var</span> users = db.addCollection(<span class="string">"users"</span>);</span><br><span class="line"></span><br><span class="line">users.insert(&#123;<span class="attr">name</span>:<span class="string">'odin'</span>, <span class="attr">age</span>: <span class="number">50</span>&#125;);</span><br><span class="line">users.insert(&#123;<span class="attr">name</span>:<span class="string">'thor'</span>, <span class="attr">age</span>: <span class="number">35</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = users.find(&#123; <span class="attr">age</span> : &#123; <span class="attr">$lte</span>: <span class="number">35</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dumps array with 1 doc (thor) to console</span></span><br><span class="line"><span class="built_in">console</span>.log(result);</span><br></pre></td></tr></table></figure>
<h3 id="Autosave-autoload-quickstart-with-default-LokiFsAdapter-async-i-o"><a href="#Autosave-autoload-quickstart-with-default-LokiFsAdapter-async-i-o" class="headerlink" title="Autosave/autoload quickstart with default LokiFsAdapter (async i/o) :"></a>Autosave/autoload quickstart with default LokiFsAdapter (async i/o) :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db = <span class="keyword">new</span> loki(<span class="string">'quickstart.db'</span>, &#123;</span><br><span class="line">	autoload: <span class="literal">true</span>,</span><br><span class="line">	autoloadCallback : databaseInitialize,</span><br><span class="line">	autosave: <span class="literal">true</span>, </span><br><span class="line">	autosaveInterval: <span class="number">4000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// implement the autoloadback referenced in loki constructor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">databaseInitialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> entries = db.getCollection(<span class="string">"entries"</span>);</span><br><span class="line">  <span class="keyword">if</span> (entries === <span class="literal">null</span>) &#123;</span><br><span class="line">    entries = db.addCollection(<span class="string">"entries"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// kick off any program logic or start listening to external events</span></span><br><span class="line">  runProgramLogic();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example method with any bootstrap logic to run after database initialized</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runProgramLogic</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> entryCount = db.getCollection(<span class="string">"entries"</span>).count();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"number of entries in database : "</span> + entryCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you expect your database to grow over 100mb or you experience slow save speeds you might to use our more high-performance LokiFsStructuredAdapter. This adapter utilitizes es6 generator iterators and node streams to stream the database line by line. It will also save each collection into its own file (partitioned) with a file name derived from the base name. This database should scale to support databases just under 1 gb on the default node heap allocation of 1.4gb. Increasing heap allocation, you can push this limit further.</p>
<h3 id="An-example-using-fastest-and-most-scalable-LokiFsStructuredAdapter-for-nodejs-might-look-like"><a href="#An-example-using-fastest-and-most-scalable-LokiFsStructuredAdapter-for-nodejs-might-look-like" class="headerlink" title="An example using fastest and most scalable LokiFsStructuredAdapter (for nodejs) might look like :"></a>An example using fastest and most scalable LokiFsStructuredAdapter (for nodejs) might look like :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loki = <span class="built_in">require</span>(<span class="string">"lokijs"</span>);</span><br><span class="line"><span class="keyword">const</span> lfsa = <span class="built_in">require</span>(<span class="string">'../src/loki-fs-structured-adapter.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> adapter = <span class="keyword">new</span> lfsa();</span><br><span class="line"><span class="keyword">var</span> db = <span class="keyword">new</span> loki(<span class="string">'sandbox.db'</span>, &#123; </span><br><span class="line">  adapter : adapter,</span><br><span class="line">  autoload: <span class="literal">true</span>,</span><br><span class="line">  autoloadCallback : databaseInitialize,</span><br><span class="line">  autosave: <span class="literal">true</span>, </span><br><span class="line">  autosaveInterval: <span class="number">4000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">databaseInitialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> log = db.getCollection(<span class="string">"log"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (log === <span class="literal">null</span>) &#123;</span><br><span class="line">    db.addCollection(<span class="string">"log"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// log some random event data as part of our example</span></span><br><span class="line">  log.insert(&#123; <span class="attr">event</span>: <span class="string">'dbinit'</span>, <span class="attr">dt</span>: (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime() &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Web-快速开始"><a href="#Web-快速开始" class="headerlink" title="Web 快速开始"></a>Web 快速开始</h1><p>If you are using lokijs in a web environment, we will automatically use the built-in LokiLocalStorageAdapter. This adapter is limited to around 5mb so that won’t last long but here is how to quickly get started experimenting with lokijs :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"../../src/lokijs.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="Example-constructing-loki-for-in-memory-only-or-manual-save-load-with-default-localStorage-adapter"><a href="#Example-constructing-loki-for-in-memory-only-or-manual-save-load-with-default-localStorage-adapter" class="headerlink" title="Example constructing loki for in-memory only or manual save/load (with default localStorage adapter) :"></a>Example constructing loki for in-memory only or manual save/load (with default localStorage adapter) :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loki = <span class="keyword">new</span> loki(<span class="string">"test.db"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Example-constructing-loki-for-autoload-autosave-with-default-localStorage-adapter"><a href="#Example-constructing-loki-for-autoload-autosave-with-default-localStorage-adapter" class="headerlink" title="Example constructing loki for autoload/autosave (with default localStorage adapter) :"></a>Example constructing loki for autoload/autosave (with default localStorage adapter) :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db = <span class="keyword">new</span> loki(<span class="string">"quickstart.db"</span>, &#123;</span><br><span class="line">  autoload: <span class="literal">true</span>,</span><br><span class="line">  autoloadCallback : databaseInitialize,</span><br><span class="line">  autosave: <span class="literal">true</span>, </span><br><span class="line">  autosaveInterval: <span class="number">4000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">databaseInitialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!db.getCollection(<span class="string">"users"</span>)) &#123;</span><br><span class="line">    db.addCollection(<span class="string">"users"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you expect your database to grow up to 60megs you might want to use our LokiIndexedAdapter which can save to IndexedDb, if your browser supports it.</p>
<h3 id="Example-using-more-scalable-LokiIndexedAdapter"><a href="#Example-using-more-scalable-LokiIndexedAdapter" class="headerlink" title="Example using more scalable LokiIndexedAdapter :"></a>Example using more scalable LokiIndexedAdapter :</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;../../src/lokijs.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;../../src/loki-indexed-adapter.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter();</span><br><span class="line">var db = new loki(&quot;test.db&quot;, &#123; </span><br><span class="line">  adapter: idbAdapter,</span><br><span class="line">  autoload: true,</span><br><span class="line">  autoloadCallback : databaseInitialize,</span><br><span class="line">  autosave: true, </span><br><span class="line">  autosaveInterval: 4000</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>If you expect your database to grow over 60megs things start to get browser dependent. To provide singular guidance and since Chrome is the most popular web browser you will want to employ our LokiPartitioningAdapter in addition to our LokiIndexedAdapter. To sum up as briefly as possible, this will divide collections into their own files and if a collection exceeds 25megs (customizable) it will subdivide into separate pages(files). This allows our indexed db adapter to accomplish a single database save/load using many key/value pairs. This adapter will allow scaling up to around 300mb or so in current testing.</p>
<h3 id="An-example-using-the-LokiPartitioningAdapter-along-with-LokiIndexedAdapter-might-appear-as"><a href="#An-example-using-the-LokiPartitioningAdapter-along-with-LokiIndexedAdapter-might-appear-as" class="headerlink" title="An example using the LokiPartitioningAdapter along with LokiIndexedAdapter might appear as :"></a>An example using the LokiPartitioningAdapter along with LokiIndexedAdapter might appear as :</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;../../src/lokijs.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;../../src/loki-indexed-adapter.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter();</span><br><span class="line"></span><br><span class="line">// use paging only if you expect a single collection to be over 50 megs or so</span><br><span class="line">var pa = new loki.LokiPartitioningAdapter(idbAdapter, &#123; paging: true &#125;);</span><br><span class="line"></span><br><span class="line">var db = new loki(&apos;test.db&apos;, &#123; </span><br><span class="line">  adapter: pa,</span><br><span class="line">  autoload: true,</span><br><span class="line">  autoloadCallback : databaseInitialize,</span><br><span class="line">  autosave: true, </span><br><span class="line">  autosaveInterval: 4000</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Description-of-LokiNativescriptAdapter"><a href="#Description-of-LokiNativescriptAdapter" class="headerlink" title="Description of LokiNativescriptAdapter"></a>Description of LokiNativescriptAdapter</h1><p>This adapter can be used when developing a nativescript application for iOS or Android, it persists the loki db to the filesystem using the native platform api.</p>
<h3 id="Simple-Example-of-using-LokiNativescriptAdapter"><a href="#Simple-Example-of-using-LokiNativescriptAdapter" class="headerlink" title="Simple Example of using LokiNativescriptAdapter :"></a>Simple Example of using LokiNativescriptAdapter :</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const loki = require (&apos;lokijs&apos;);</span><br><span class="line">const LokiNativescriptAdapter = require(&apos;lokijs/src/loki-nativescript-adapter&apos;);</span><br><span class="line">let db = new loki(&apos;loki.json&apos;,&#123;</span><br><span class="line">            adapter:new LokiNativescriptAdapter()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In addition to the above adapters which are included in the lokijs distro, several community members have also created their own adapters using this adapter interface. Some of these include :</p>
</blockquote>
<ul>
<li>Cordova adapter : <a href="https://github.com/cosmith/loki-cordova-fs-adapter" target="_blank" rel="noopener">https://github.com/cosmith/loki-cordova-fs-adapter</a></li>
<li>localForage adapter : <a href="https://github.com/paulhovey/loki-localforage-adapter" target="_blank" rel="noopener">https://github.com/paulhovey/loki-localforage-adapter</a></li>
</ul>
<h1 id="Configuring-persistence-adapters"><a href="#Configuring-persistence-adapters" class="headerlink" title="Configuring persistence adapters"></a>Configuring persistence adapters</h1><h2 id="Autosave-Autoload-and-close"><a href="#Autosave-Autoload-and-close" class="headerlink" title="Autosave, Autoload and close()"></a>Autosave, Autoload and close()</h2><p>LokiJS now supports automatic saving at user defined intervals, configured via loki constructor options. This is supported for all persistenceMethods. Data is only saved if changes have occurred since the last save. You can also specify an autoload to immediately load a saved database during new loki construction. If you need to process anything on load completion you can also specify your own autoloadCallback. Finally, in an autosave scenario, if the user wants to exit or is notified of leaving the webpage (window.onbeforeunload) you can call close() on the database which will perform a final save (if needed).</p>
<blockquote>
<p><strong>*Note : the ability of loki to ‘flush’ data on events such as a browsers onbeforeunload event, depends on the storage adapter being synchronous. Local storage and file system adapters are synchronous but indexeddb is asynchronous and cannot save when triggered from db.close() in an onbeforeunload event. The mouseleave event may allow enough time to perform a preemptive save.*</strong></p>
</blockquote>
<h3 id="Autosave-example"><a href="#Autosave-example" class="headerlink" title="Autosave example"></a>Autosave example</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;loki&apos;);</span><br><span class="line">var db = new loki(&apos;test&apos;, </span><br><span class="line">  &#123;</span><br><span class="line">    autosave: true, </span><br><span class="line">    autosaveInterval: 10000, // 10 seconds</span><br><span class="line">    adapter: idbAdapter</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Autosave-with-autoload-example"><a href="#Autosave-with-autoload-example" class="headerlink" title="Autosave with autoload example"></a>Autosave with autoload example</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new lokiIndexedAdapter(&apos;loki&apos;);</span><br><span class="line">var db = new loki(&apos;test.db&apos;, </span><br><span class="line">  &#123;</span><br><span class="line">    autoload: true,</span><br><span class="line">    autoloadCallback : loadHandler,</span><br><span class="line">    autosave: true, </span><br><span class="line">    autosaveInterval: 10000, // 10 seconds</span><br><span class="line">    adapter: idbAdapter</span><br><span class="line">  &#125;); </span><br><span class="line"></span><br><span class="line">function loadHandler() &#123;</span><br><span class="line">  // if database did not exist it will be empty so I will intitialize here</span><br><span class="line">  var coll = db.getCollection(&apos;entries&apos;);</span><br><span class="line">  if (coll === null) &#123;</span><br><span class="line">    coll = db.addCollection(&apos;entries&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://rawgit.com/techfort/LokiJS/master/examples/sandbox/LokiSandbox.htm#rawgist=https://gist.githubusercontent.com/obeliskos/447edca33d1274dd9a64767d23df56e9/raw/740d3bedc1ed76d3718acd207b6913281a11ed78/autoloadCallback" target="_blank" rel="noopener">Try in Loki Sandbox</a>.</p>
<h1 id="Save-throttling-and-persistence-contention-management"><a href="#Save-throttling-and-persistence-contention-management" class="headerlink" title="Save throttling and persistence contention management"></a>Save throttling and persistence contention management</h1><p>LokiJS now supports throttled saves and loads to avoid overlapping saveDatabase and loadDatabase calls from interfering with each other. This is controlled by a loki constructor option called ‘throttledSaves’ and the default for that option is ‘true’.</p>
<p>This means that within any single Loki database instance, multiple saves routed to the persistence adapter will be throttled and ensured to not conflict by overlap. With save throttling, during the time between an adapter save and an adapter response to that save, if new save requests come in we will queue those requests (and their callbacks) for a save which we will initiate immediately after the current save is complete. In that situation, if 10 requests to save had been made while a save is pending, the subsequent (single) save will callback all ten queued/tiered callbacks when -it- completes.</p>
<p>If a loadDatabase call occurs while a save is pending, we will (by default) wait indefinitely for the queue to deplete without being replenished. Once that occurs we will lock all saves during the load… any incoming save requests made while the database is being loaded will then be queued for saving once the load is completed. Since loadDatabase now internally calls a new ‘throttledSaveDrain’ we will pass through options to control that drain. (These options will be summarized below).</p>
<p>You may also directly call this ‘throttledSaveDrain’ loki method which can wait for the queue to drain. You might do this using any of these variations/options :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// wait indefinitely (recursively)</span><br><span class="line">db.throttledSaveDrain(function () &#123;</span><br><span class="line">  console.log(&quot;no saves in progress&quot;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// wait only for the -current- queue to deplete</span><br><span class="line">db.throttledSaveDrain(function () &#123;</span><br><span class="line">  console.log(&quot;queue drained&quot;);</span><br><span class="line">&#125;, &#123; recursiveWait: false &#125; );</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// wait recursively but only for so long...</span><br><span class="line">db.throttledSaveDrain(function (success) &#123;</span><br><span class="line">  if (success) &#123;</span><br><span class="line">    console.log(&quot;no saves in progress&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    console.log(&quot;taking too long, try again later&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123; recursiveWaitLimit: true, recursiveWaitLimitDuration: 2000 &#125;);</span><br></pre></td></tr></table></figure>
<p>If you do not wish loki to supervise these conflicts with its throttling contention management, you can disable this by constructing loki with the following option (in addition to any existing options you are passing) :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var db = new loki(&apos;test.db&apos;, &#123; throttledSaves: false &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="Creating-your-own-Loki-Persistence-Adapters"><a href="#Creating-your-own-Loki-Persistence-Adapters" class="headerlink" title="Creating your own Loki Persistence Adapters"></a>Creating your own Loki Persistence Adapters</h1><p>Lokijs currently supports two types of database adapters : ‘basic’, and ‘reference’ mode adapters. Basic adapters are passed a string to save and return a string when loaded… this is well suited to key/value stores. Reference mode adapters are passed a reference to the database itself where it can save however it wishes to. When loading, reference mode adapters can return an object reference or serialized string. Below we will describe the minimal functionality which lokijs requires, you may want to provide additional adapter functionality for deleting or inspecting its persistence store.</p>
<h1 id="Creating-your-own-‘Basic’-persistence-adapter"><a href="#Creating-your-own-‘Basic’-persistence-adapter" class="headerlink" title="Creating your own ‘Basic’ persistence adapter"></a>Creating your own ‘Basic’ persistence adapter</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MyCustomAdapter.prototype.loadDatabase = function(dbname, callback) &#123;</span><br><span class="line">  // using dbname, load the database from wherever your adapter expects it</span><br><span class="line">  var serializedDb = localStorage[dbname];</span><br><span class="line"></span><br><span class="line">  var success = true; // make your own determinations</span><br><span class="line"></span><br><span class="line">  if (success) &#123;</span><br><span class="line">    callback(serializedDb);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    callback(new Error(&quot;There was a problem loading the database&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and a saveDatabase example might look like :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MyCustomAdapter.prototype.saveDatabase = function(dbname, dbstring, callback) &#123;</span><br><span class="line">  // store the database, for this example to localstorage</span><br><span class="line">  localStorage[dbname] = dbstring;</span><br><span class="line"></span><br><span class="line">  var success = true;  // make your own determinations</span><br><span class="line">  if (success) &#123;</span><br><span class="line">    callback(null);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    callback(new Error(&quot;An error was encountered loading &quot; + dbname + &quot; database.&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Creating-your-own-‘Reference-Mode’-persistence-adapter"><a href="#Creating-your-own-‘Reference-Mode’-persistence-adapter" class="headerlink" title="Creating your own ‘Reference Mode’ persistence adapter"></a>Creating your own ‘Reference Mode’ persistence adapter</h1><p>An additional ‘level’ of adapter support would be for your adapter to support <strong>‘reference’</strong> mode support. This ‘reference’ mode will allow lokijs to provide your adapter with a reference to a lightweight ‘copy’ of the database sharing only the collection.data[] document object instances with the original database. You would use this reference to destructure or save however you want to.</p>
<p>To instruct loki that your adapter supports ‘reference’ mode, you will need to implement a top level property called ‘mode’ on your adapter and set it equal to ‘reference’. Having done that and configured that adapter to be used, whenever loki wishes to save the database it will instead call out to an exportDatabase() method on your adapter.</p>
<p>A simple example of an advanced ‘reference’ mode adapter might look like :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function YourAdapter() &#123;</span><br><span class="line">   this.mode = &quot;reference&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">YourAdapter.prototype.exportDatabase = function(dbname, dbref, callback) &#123;</span><br><span class="line">  this.customSaveLogic(dbref);</span><br><span class="line"></span><br><span class="line">  var success = true; // make your own determinations</span><br><span class="line"></span><br><span class="line">  if (success) &#123;</span><br><span class="line">    callback(null);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    callback(new Error(&quot;some error occurred.&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// reference mode uses the same loadDatabase method signature</span><br><span class="line">YourAdapter.prototype.loadDatabase = function(dbname, callback) &#123;</span><br><span class="line">  // do some magic to reconstruct a new loki database object instance from wherever</span><br><span class="line">  var newDatabase = this.customLoadLogic();</span><br><span class="line"> </span><br><span class="line">  var success = true; // make you own determinations</span><br><span class="line"></span><br><span class="line">  // once reconstructed, loki will expect either a serialized response or a Loki object instance to reinflate from</span><br><span class="line">  if (success) &#123;</span><br><span class="line">    callback(newSerialized);</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    callback(new Error(&quot;some error&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="LokiPartitioningAdapter"><a href="#LokiPartitioningAdapter" class="headerlink" title="LokiPartitioningAdapter"></a>LokiPartitioningAdapter</h1><p>This is an adapter for adapters. It wraps around and converts any ‘basic’ persistence adapter into one that scales nicely to your memory contraints. It can split your database up, saving each collection independently and only if changes have occurred since the last save. Since each collection is saved separately there is lower memory overhead and since only dirty collections are saved there is improved i/o save speeds.</p>
<blockquote>
<p>Chrome (using indexedDb) places a restriction on how large a single saved ‘chunk’ can be, this Partitioning adapter with just partitioning raises that limit from being ‘per db’ to ‘per collection’… when paging is enabled that limit is raised to being ‘per document’. Chrome indexedDb limit is somewhere around 30-60megs sized chunks.</p>
</blockquote>
<p>An example using partition adapter with our LokiIndexedAdapter might appear such as :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;appAdapter&apos;);</span><br><span class="line">var pa = new loki.LokiPartitioningAdapter(idbAdapter);</span><br><span class="line"></span><br><span class="line">var db = new loki(&apos;sandbox.db&apos;, &#123; adapter: pa &#125;);</span><br></pre></td></tr></table></figure>
<p>If you expect a single collection to grow rather large you may even want to utilize an additional ‘paging’ mode that this adapter provides. This is useful if you want to limit the size of data sent to the inner persistence adapter. This paging mode was added to accomodate a Chrome limitation on maximum record sizes. An example using paging mode might appear as follows :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;appAdapter&apos;);</span><br><span class="line">var pa = new loki.LokiPartitioningAdapter(idbAdapter, &#123; paging: true &#125;);</span><br><span class="line"></span><br><span class="line">var db = new loki(&apos;sandbox.db&apos;, &#123; adapter: pa &#125;);</span><br></pre></td></tr></table></figure>
<p>You can also pass in a pageSize option if you wish to use a page size other than the default 25meg page size.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// set up adapter to page using 35 meg page size</span><br><span class="line">var pa = new loki.LokiPartitioningAdapter(idbAdapter, &#123; paging: true, pageSize:35*1024*1024 &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="LokiMemoryAdapter"><a href="#LokiMemoryAdapter" class="headerlink" title="LokiMemoryAdapter"></a>LokiMemoryAdapter</h1><p>This ‘basic’ persistence adapter is only intended for experimenting and testing since it retains its key/value store in memory and will be lost when session is done. This enables us to verify the partitioning adapter works and can be used to mock persistence for unit testing.</p>
<p>You might access this memory adapter (which is included in the main source file) similarly to the following :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var mem = new loki.LokiMemoryAdapter();</span><br><span class="line">var db = new loki(&apos;sandbox.db&apos;, &#123;adapter: mem&#125;);</span><br></pre></td></tr></table></figure>
<p>If you wish to simulate asynchronous ‘basic’ adapter you can pass options to its constructor :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// simulate 50ms async delay for loads and saves. this will yield thread until then</span><br><span class="line">var mem = new loki.LokiMemoryAdapter(&#123; asyncResponses: true, asyncTimeout: 50 &#125;);</span><br><span class="line">var db = new loki(&apos;sandbox.db&apos;, &#123;adapter: mem&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In order to see LokiPartitioningAdapter used in conjunction with LokiMemoryAdapter you can view this <a href="https://rawgit.com/techfort/LokiJS/master/examples/sandbox/LokiSandbox.htm#rawgist=https://gist.githubusercontent.com/obeliskos/15c1aa87da16cd89b328eb84bbcdf8fa/raw/d91ac3fee212dc5aa96cb05f479d825faa17c1c8/PartitionedMemoryAdapterTest" target="_blank" rel="noopener">Loki Sandbox gist</a> in your browser.</p>
</blockquote>
<p>What is happening in the gist linked above is that we create an instance of a LokiMemoryAdapter and pass that instance to the LokiPartitioningAdapter. We utilimately pass in the created LokiPartitioningAdapter instance to the database constructor. We then add multiple collections to our database, save it, update one of the collections (causing that collection’s ‘dirty’ flag to be set), and save again. When we examine the output of the script we can view the contents of the memory adapter’s internal hash store to see how there are multiple keys for a single database. We can also see that our modified collection (along with the database container itself) was saved again. The database container currently has no ‘dirty’ flag set but since we remove all collection.data[] object instances from it, it is relatively lightweight.</p>
<h1 id="‘Rolling-your-own’-structured-serialization-mechanism"><a href="#‘Rolling-your-own’-structured-serialization-mechanism" class="headerlink" title="‘Rolling your own’ structured serialization mechanism"></a>‘Rolling your own’ structured serialization mechanism</h1><p>In addition to the <a href="https://github.com/techfort/LokiJS/wiki/Changes-API" target="_blank" rel="noopener">ChangesAPI</a> which can be utilized to isolate changesets, LokiJS has established several internal utility methods to assist users in developing optimal persistence or transmission of database contents.</p>
<p>Those mechanisms include the ability to decompose the database into ‘partitions’ of structured serializations or assembled into a line oriented format (non-partitioned) and either delimited (single delimited string per collection) or non-delimited (array of strings, one per document). These utility methods are located on the Loki object instance itself as the ‘serializeDestructured’ and ‘deserializeDestructured’ methods. They can be invoked to create structured json serialization for the entire database, or (if you pass a partition option) it can provide a single partition at a time. Internal loki structured serialization in its current form provides mild memory overhead reduction and decreases I/O time if only some collections need to be saved. It may also be useful for other data exchange or synchronization mechanisms.</p>
<p>In lokijs terminology the partitions of a database include the database container (partition -1) along with each individual collection (partitions 0-n).</p>
<p>To destructure in various formats you can experiment with the following parameters :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var result = db.serializeDestructured(&#123;</span><br><span class="line">  partitioned: false,</span><br><span class="line">  delimited: false</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>To destructure a single partition you might use the following syntax and experiment with ‘delimited’ and ‘partition’ properties :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var result = db.serializeDestructured(&#123;</span><br><span class="line">  partitioned: true,</span><br><span class="line">  partition: 1,</span><br><span class="line">  delimited: false</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>To experiment with the various structured serialization formats you can view this <a href="https://rawgit.com/techfort/LokiJS/master/examples/sandbox/LokiSandbox.htm#rawgist=https://gist.githubusercontent.com/obeliskos/98a73205d7fe9746a687634e19a5eb89/raw/3821c9bbb6bae2689b00d16be9fae78dff430e28/destructuring%2520demo" target="_blank" rel="noopener">Loki Sandbox gist</a> and try various combinations of ‘partitioned’ and ‘delimited’ options (making sure both the serializeDestructured and deserializeDestructured use the same values.</p>
</blockquote>
<p>Destructuring (making many smaller json serializations vs one large serialization) does not lower memory overhead but seems to be a little faster. Partitioning can reduce memory overhead if you can dispose of those memory chunks before advancing to the next (which our adapter implementations do). Our 2.0.0 branch which is able to use ES6 language constructs may gain an iterable interface in the future for data exchange or line-by-line streaming.</p>
<p>If your database is small enough you can use the LokiPartitioningAdapter (with or without paging) along with LokiMemoryAdapter to decompose database into appropriately sized ‘chunks’ for transmission.</p>
<h1 id="Detailed-LokiIndexedAdapter-Description"><a href="#Detailed-LokiIndexedAdapter-Description" class="headerlink" title="Detailed LokiIndexedAdapter Description"></a>Detailed LokiIndexedAdapter Description</h1><p>Our LokiIndexedAdapter is implemented as a ‘basic’ mode loki persistence adapter. Since this will probably be the default web persistence adapter, this section will overview some of its advanced features.</p>
<p>It implements persistence by defining an app/key/value database in indexeddb for storing serialized databases (or partitions). The ‘app’ portion is designated when instantiating the adapter and loki only supplies it key/value pair for storage.</p>
<h3 id="Simple-Example-of-using-LokiIndexedAdapter-for-browser-environments"><a href="#Simple-Example-of-using-LokiIndexedAdapter-for-browser-environments" class="headerlink" title="Simple Example of using LokiIndexedAdapter (for browser environments) :"></a>Simple Example of using LokiIndexedAdapter (for browser environments) :</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;scripts/lokijs/lokijs.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;scripts/lokijs/loki-indexed-adapter.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">var db = new loki(&apos;test&apos;, &#123; adapter: idbAdapter &#125;);</span><br></pre></td></tr></table></figure>
<p>Note the ‘finance’ in this case represents an ‘App’ context and the ‘test’ designates the key (or database name)… the ‘value’ is the serialized strings representing your database which loki will provide. Advantages include larger storage limits over localstorage, and a catalog based approach where you can store many databases, grouped by an ‘App’ context. Since indexedDB storage is provided ‘per-domain’, and on any given domain you might be running several web ‘apps’ each with its own database(s), this structure allows for organization and expandibility.</p>
<blockquote>
<p><strong>*Note : the ‘App’ context is an conceptual separation, not a security partition. Security is provided by your web browser, partitioned per-domain within client storage in the browser/system.*</strong></p>
</blockquote>
<h1 id="Loki-Indexed-adapter-interface"><a href="#Loki-Indexed-adapter-interface" class="headerlink" title="Loki Indexed adapter interface"></a>Loki Indexed adapter interface</h1><p>In addition to core loadDatabase and saveDatabase methods, the loki Indexed adapter provides the ability to getDatabaseList (for the current app context), deleteDatabase, and getCatalogSummary to retrieve unfiltered list of app/keys along with the size in database. (Note sizes reported may not be Unicode sizes so effective ‘size’ it may consume might be double that amount as indexeddb saves in Unicode). The loki indexed adapter also is console-friendly… even though indexeddb is highly asynchronous, relying on callbacks, you can omit callbacks for many of its methods and will log results to console instead. This makes experimenting, diagnosing, and maintenance of loki catalog easier to learn and inspect.</p>
<h3 id="Full-Examples-of-using-loki-indexed-adapter"><a href="#Full-Examples-of-using-loki-indexed-adapter" class="headerlink" title="Full Examples of using loki indexed adapter"></a>Full Examples of using loki indexed adapter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">// Save : will save App/Key/Val as &apos;finance&apos;/&apos;test&apos;/&#123;serializedDb&#125;</span><br><span class="line">// if appContect (&apos;finance&apos; in this example) is omitted, &apos;loki&apos; will be used</span><br><span class="line">var idbAdapter = new lokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">var db = new loki(&apos;test&apos;, &#123; adapter: idbAdapter &#125;);</span><br><span class="line">var coll = db.addCollection(&apos;testColl&apos;);</span><br><span class="line">coll.insert(&#123;test: &apos;val&apos;&#125;);</span><br><span class="line">db.saveDatabase();  // could pass callback if needed for async complete</span><br><span class="line"></span><br><span class="line">// Load database</span><br><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">var db = new loki(&apos;test&apos;, &#123; adapter: idbAdapter &#125;);</span><br><span class="line">db.loadDatabase(&#123;&#125;, function(result) &#123;</span><br><span class="line">  console.log(&apos;done&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// Get database list</span><br><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">idbAdapter.getDatabaseList(function(result) &#123;</span><br><span class="line">  // result is array of string names for that appcontext (&apos;finance&apos;)</span><br><span class="line">  result.forEach(function(str) &#123;</span><br><span class="line">    console.log(str);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// Delete database</span><br><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">idbAdapter.deleteDatabase(&apos;test&apos;); // delete &apos;finance&apos;/&apos;test&apos; value from catalog</span><br><span class="line"></span><br><span class="line">// Delete database partitions and/or pages</span><br><span class="line">// This deletes all partitions or pages derived from this base filename</span><br><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">idbAdapter.deleteDatabasePartitions(&apos;test&apos;); </span><br><span class="line"></span><br><span class="line">// Summary</span><br><span class="line">var idbAdapter = new LokiIndexedAdapter(&apos;finance&apos;);</span><br><span class="line">idbAdapter.getCatalogSummary(function(entries) &#123;</span><br><span class="line">  entries.forEach(function(obj) &#123;</span><br><span class="line">    console.log(&quot;app : &quot; + obj.app);</span><br><span class="line">    console.log(&quot;key : &quot; + obj.key);</span><br><span class="line">    console.log(&quot;size : &quot; + obj.size);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Examples-of-using-loki-Indexed-adapter-from-console"><a href="#Examples-of-using-loki-Indexed-adapter-from-console" class="headerlink" title="Examples of using loki Indexed adapter from console"></a>Examples of using loki Indexed adapter from console</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CONSOLE USAGE : if using from console for management/diagnostic, here are a few examples :</span></span><br><span class="line"><span class="keyword">var</span> adapter = <span class="keyword">new</span> LokiIndexedAdapter(<span class="string">'loki'</span>);  <span class="comment">// or whatever appContext you want to use</span></span><br><span class="line">adapter.getDatabaseList(); <span class="comment">// with no callback passed, this method will log results to console</span></span><br><span class="line">adapter.saveDatabase(<span class="string">'UserDatabase'</span>, <span class="built_in">JSON</span>.stringify(myDb));</span><br><span class="line">adapter.loadDatabase(<span class="string">'UserDatabase'</span>); <span class="comment">// will log the serialized db to console</span></span><br><span class="line">adapter.deleteDatabase(<span class="string">'UserDatabase'</span>);</span><br><span class="line">adapter.getCatalogSummary(); <span class="comment">// gets list of all keys along with their sizes</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs3_query_examples/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs3_query_examples/" itemprop="url">
                  查询示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs3_query_examples/" class="leancloud_visitors" data-flag-title="查询示例">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="注意：我们现在在这个库的’examples’子文件夹中有几个快速入门示例。"><a href="#注意：我们现在在这个库的’examples’子文件夹中有几个快速入门示例。" class="headerlink" title="注意：我们现在在这个库的’examples’子文件夹中有几个快速入门示例。"></a>注意：我们现在在这个库的’examples’子文件夹中有几个快速入门示例。</h3><blockquote>
<p><a href="https://github.com/techfort/LokiJS/blob/master/examples/quickstart-core.js" target="_blank" rel="noopener">https://github.com/techfort/LokiJS/blob/master/examples/quickstart-core.js</a></p>
<p> <a href="https://github.com/techfort/LokiJS/blob/master/examples/quickstart-chaining.js" target="_blank" rel="noopener">https://github.com/techfort/LokiJS/blob/master/examples/quickstart-chaining.js</a></p>
<p><a href="https://github.com/techfort/LokiJS/blob/master/examples/quickstart-transforms.js" target="_blank" rel="noopener">https://github.com/techfort/LokiJS/blob/master/examples/quickstart-transforms.js</a></p>
<p><a href="https://github.com/techfort/LokiJS/blob/master/examples/quickstart-dynview.js" target="_blank" rel="noopener">https://github.com/techfort/LokiJS/blob/master/examples/quickstart-dynview.js</a></p>
<p>对于持久性示例，我们在 <a href="https://rawgit.com/techfort/LokiJS/master/examples/sandbox/LokiSandbox.htm" target="_blank" rel="noopener">Loki Sandbox </a>中的 <a href="https://github.com/techfort/LokiJS/tree/master/examples" target="_blank" rel="noopener">示例文件夹</a> 和Web快速入门要点中编号了节点快速入门。</p>
</blockquote>
<h3 id="设计查询"><a href="#设计查询" class="headerlink" title="设计查询"></a>设计查询</h3><p>LokiJS衍生出了多种查询数据库的机制。在最高抽象层次上，让我们将这些方法分为以下几类：</p>
<ul>
<li>核心方法 - 直接应用于集合的查询的简单而强大的方法。</li>
<li>链（通过Resultset） - 允许按顺序排序(sorting)，限制(limiting)，偏移(offsets)和多个查询(multiple queries)。</li>
<li>链变换 - 类似于上面的方法链，但在可以序列化的对象结构中定义。</li>
<li>动态视图  - 允许具有可能较大结果集的常用查询以获得最佳性能和可用性。</li>
</ul>
<p>在每种方法中，您的查询通常属于<code>find</code>和<code>where</code>类别。</p>
<h3 id="‘Where’-查询"><a href="#‘Where’-查询" class="headerlink" title="‘Where’ 查询"></a>‘Where’ 查询</h3><p>这些查询利用<code>JavaScript函数</code>来过滤数据。<strong>这是用于过滤集合中文档的最慢但最通用的方法。</strong>从本质上讲，我们将在集合中的每个文档上应用过滤器，以查看它是否应该放在结果集中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单的匿名过滤器</span></span><br><span class="line"><span class="keyword">var</span> results = coll.where(<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj.legs === <span class="number">8</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -或- 设置命名过滤器函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleipnirFilter</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj.legs === <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 然后传递给where函数</span></span><br><span class="line">results = coll.where(sleipnirFunction);</span><br></pre></td></tr></table></figure>
<h3 id="‘Find’-查询"><a href="#‘Find’-查询" class="headerlink" title="‘Find’ 查询"></a>‘Find’ 查询</h3><p><strong><code>Find查询</code>基于<code>mongo查询</code>语法的子集，并且能够使用<code>索引</code>来加速查询。</strong><u>与<code>集合变换(Collection Transforms)</code>或<code>动态视图(Dynamic Views)</code>一起使用时，这些过滤器可以保存到数据库本身中。</u><strong>这是查询Loki数据库的首选方法。</strong><u>使用<code>Find</code>查询所有内容（或尽可能多地过滤），如果发现不支持的边界情况，则使用<code>&#39;where&#39;</code>过滤。</u></p>
<h3 id="‘Find’-操作符示例"><a href="#‘Find’-操作符示例" class="headerlink" title="‘Find’ 操作符示例 :"></a>‘Find’ 操作符示例 :</h3><p><strong>[目前增加和审查几个操作符的功能…我们可能应该用更好的例子来扩展本节的更多细节]</strong></p>
<p>目前支持的主要操作符：</p>
<p><strong>$eq-(equal)</strong> - 过滤具有(严格)<code>相等</code>属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 隐式（假设已经使用了$eq运算符）</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'Name'</span>: <span class="string">'Odin'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显式 $eq</span></span><br><span class="line">results = coll.find(&#123;<span class="string">'Name'</span>: &#123; <span class="string">'$eq'</span> : <span class="string">'Odin'</span> &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$ne-(not equal</strong>) -对属性<code>不等于</code>提供值的文档进行过滤</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不等于测试</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'legs'</span>: &#123; <span class="string">'$ne'</span> : <span class="number">8</span> &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$aeq-(abstract equal)</strong> - 过滤具有抽象（非严格）<code>等同</code>性质的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将匹配20岁或20岁的文档</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(age: &#123;<span class="attr">$aeq</span>: <span class="number">20</span>&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$dteq-(date equal)</strong> - 过滤<code>日期属性等于</code>提供日期值的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dt1 = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"1/1/2017"</span>);</span><br><span class="line"><span class="keyword">var</span> dt2 = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"1/1/2017"</span>);</span><br><span class="line"></span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'mjolnir'</span>, <span class="attr">created</span>: dt1 &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'gungnir'</span>, <span class="attr">created</span>: dt2 &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回上述两个插入的文档</span></span><br><span class="line"><span class="keyword">var</span> results = items.find(&#123; <span class="attr">created</span>: &#123; <span class="attr">$dteq</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"1/1/2017"</span>) &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$gt-(greater than)</strong> - 过滤属性<code>大于</code>提供值的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$gt'</span>: <span class="number">40</span>&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$gte-(greater than equal)</strong> -过滤具有<code>大于或等于</code>提供值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$gte'</span>: <span class="number">40</span>&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$lt-(less than)</strong> - 过滤属性<code>小于</code>提供值的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$lt'</span>: <span class="number">40</span>&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$lte-(less than equal)</strong> - 过滤属性<code>小于或等于</code>提供值的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$lte'</span>: <span class="number">40</span>&#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$between</strong> - 通过提供的属性过滤出在提供的值<code>之间</code>的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匹配50至75之间的计数值的用户</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="attr">count</span> : &#123; <span class="string">'$between'</span>: [<span class="number">50</span>, <span class="number">75</span>] &#125;&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：上面的<code>$gt，$gte，$lt，$lte</code>和<code>$ops</code>之间使用<code>&#39;loki&#39;</code>排序，它提供了一个统一范围的<code>actoss</code>混合类型，并返回相同的结果，无论属性是否被索引。这对二进制索引和保证索引和非索引比较结果相等是必需的。</p>
<p>如果您不希望利用二进制索引，并且您希望简单的JavaScript比较可以接受，那么我们提供以下操作（由于它们的简化比较）可以提供更优化的执行速度。</p>
<p><strong>$jgt-(javascipt greater than)</strong> - 过滤(使用简化的JavaScript比较)出具有<code>大于</code>给定值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$jgt'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>$jgte-(javascipt greater than equal)</strong> - 过滤(使用简化的JavaScript比较)出具有<code>大于等于</code>给定值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$jgte'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>$jlt-(javascipt less than)</strong> - 过滤(使用简化的JavaScript比较)出具有<code>小于</code>给定值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$jlt'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>$jlte-(javascipt less than equal)</strong> - 过滤(使用简化的JavaScript比较)出具有<code>小于等于</code>给定值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> results = coll.find(&#123;<span class="string">'age'</span>: &#123;<span class="string">'$jlte'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>$jbetween</strong>- 通过提供的属性过滤(使用简化的JavaScript比较)出在提供的值<code>之间</code>的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> results = users.find(&#123; <span class="attr">count</span> : &#123; <span class="string">'$jbetween'</span>: [<span class="number">50</span>, <span class="number">75</span>] &#125;&#125;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>$regex</strong> - 根据提供的正则表达式过滤出具有属性匹配的文档</p>
<blockquote>
<p>如果在<code>命名转换</code>或<code>动态视图</code>过滤器中使用正则表达式操作符，最好使用<code>后两个示例</code>，因为原始正则表达式好像没有<code>序列化/反序列化</code>。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入原始正则表达式</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'Name'</span>: &#123; <span class="string">'$regex'</span> : <span class="regexp">/din/</span> &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//或仅传递字符串模式</span></span><br><span class="line">results = coll.find(&#123;<span class="string">'Name'</span>: &#123; <span class="string">'$regex'</span>: <span class="string">'din'</span> &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或传入[pattern，options]字符串数组</span></span><br><span class="line">results = coll.find(&#123;<span class="string">'Name'</span>: &#123; <span class="string">'$regex'</span>: [<span class="string">'din'</span>, <span class="string">'i'</span>] &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$in</strong> - 过滤具有与所提供的数组值<code>相匹配</code>的属性的文档。你的属性不应该是一个数组，但你的比较值应该是。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'odin'</span> &#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'thor'</span> &#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'svafrlami'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在数组集合['odin'，'thor']中将用户与名称进行匹配</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'name'</span> : &#123; <span class="string">'$in'</span> : [<span class="string">'odin'</span>, <span class="string">'thor'</span>] &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$nin</strong> -  过滤具有与所提供的数组值<code>不匹配</code>的属性的文档。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'odin'</span> &#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'thor'</span> &#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'svafrlami'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将用户与名称不匹配的用户匹配['odin'，'thor']（仅svafrlami文档符合）</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'name'</span> : &#123; <span class="string">'$nin'</span> : [<span class="string">'odin'</span>, <span class="string">'thor'</span>] &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$keyin</strong> - filter for document(s) whose property value is defined in the provided hash object keys.<em>(Equivalent to $in: Object.keys(hashObject))</em> ( <a href="https://github.com/techfort/LokiJS/issues/362" target="_blank" rel="noopener">#362</a>, <a href="https://github.com/techfort/LokiJS/issues/365" target="_blank" rel="noopener">#365</a> )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">categories.insert(&#123; <span class="attr">name</span>: <span class="string">'Title'</span>, <span class="attr">column</span>: <span class="string">'title'</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// since the op doesn't use the title value, this is most effective with existing objects</span></span><br><span class="line"><span class="keyword">var</span> result = categories.find(&#123;<span class="attr">column</span>: &#123; <span class="attr">$keyin</span>: &#123; <span class="attr">title</span>: <span class="string">'anything'</span>&#125; &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$nkeyin</strong> - filter for document(s) whose property value is not defined in the provided hash object keys. <strong>(Equivalent to $nin: Object.keys(hashObject))</strong> ( <a href="https://github.com/techfort/LokiJS/issues/362" target="_blank" rel="noopener">#362</a>, <a href="https://github.com/techfort/LokiJS/issues/365" target="_blank" rel="noopener">#365</a> )</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = categories.find(&#123;<span class="attr">column</span>: &#123; <span class="attr">$nkeyin</span>: &#123; <span class="attr">title</span>: <span class="string">'anything'</span>&#125; &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$definedin</strong> - filter for document(s) whose property value is defined in the provided hash object as a value other than <strong>undefined</strong>. <a href="https://github.com/techfort/LokiJS/issues/285" target="_blank" rel="noopener">#285</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'mjolnir'</span>, <span class="attr">owner</span>: <span class="string">'thor'</span>, <span class="attr">maker</span>: <span class="string">'dwarves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'gungnir'</span>, <span class="attr">owner</span>: <span class="string">'odin'</span>, <span class="attr">maker</span>: <span class="string">'elves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'tyrfing'</span>, <span class="attr">owner</span>: <span class="string">'Svafrlami'</span>, <span class="attr">maker</span>: <span class="string">'dwarves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'draupnir'</span>, <span class="attr">owner</span>: <span class="string">'odin'</span>, <span class="attr">maker</span>: <span class="string">'elves'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns gungnir and draupnir.  similar to $keyin, the value ('rule') is not used by the op</span></span><br><span class="line"><span class="keyword">var</span> results = items.find(&#123;<span class="attr">maker</span>: &#123; <span class="attr">$efinedin</span>: &#123; <span class="attr">elves</span>: <span class="string">'rule'</span> &#125; &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$undefinedin</strong> - filter for document(s) whose property value is not defined in the provided hash object or defined but is <strong>undefined</strong>. <a href="https://github.com/techfort/LokiJS/issues/285" target="_blank" rel="noopener">#285</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'mjolnir'</span>, <span class="attr">owner</span>: <span class="string">'thor'</span>, <span class="attr">maker</span>: <span class="string">'dwarves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'gungnir'</span>, <span class="attr">owner</span>: <span class="string">'odin'</span>, <span class="attr">maker</span>: <span class="string">'elves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'tyrfing'</span>, <span class="attr">owner</span>: <span class="string">'Svafrlami'</span>, <span class="attr">maker</span>: <span class="string">'dwarves'</span> &#125;);</span><br><span class="line">items.insert(&#123; <span class="attr">name</span> : <span class="string">'draupnir'</span>, <span class="attr">owner</span>: <span class="string">'odin'</span>, <span class="attr">maker</span>: <span class="string">'elves'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns mjolnir and tyrfing where the 'dwarves' val is not a property on our passed object</span></span><br><span class="line"><span class="keyword">var</span> results = items.find(&#123;<span class="attr">maker</span>: &#123; <span class="attr">$undefinedin</span>: &#123; <span class="attr">elves</span>: <span class="string">'rule'</span> &#125; &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$contains</strong> - 过滤包含提供值的属性的文档. ( <a href="https://github.com/techfort/LokiJS/pull/120/commits/1f08433203554ccf00b381cbea4e72e25e62d5da" target="_blank" rel="noopener">commit</a>, <a href="https://github.com/techfort/LokiJS/issues/205" target="_blank" rel="noopener">#205</a> ). 当你的属性包含一个数组，但你的比较值不是一个数组时，请使用它。.</p>
<blockquote>
<p>当<code>typeof</code>属性是：</p>
<ul>
<li>string: 它会为你的字符串做一个子字符串匹配(indexOf)</li>
<li>array: 它会检查该数组中是否存在“value”(indexOf)</li>
<li>object: 它会检查你的’值’是否是该对象的一个定义的属性</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'odin'</span>, <span class="attr">weapons</span> : [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'thor'</span>, <span class="attr">weapons</span> : [<span class="string">'mjolnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'svafrlami'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'arngrim'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns 'svafrlami' and 'arngrim' documents</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'weapons'</span> : &#123; <span class="string">'$contains'</span> : <span class="string">'tyrfing'</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$containsAny</strong> - 过滤包含任何提供值的属性的文档。当你的属性包含一个数组时，使用这个 - 并且你的比较值是一个数组。</p>
<blockquote>
<p>When typeof property is :</p>
<ul>
<li>string: 它会为你的字符串做一个子字符串匹配(indexOf)</li>
<li>array: 它会检查该数组中是否存在“value”(indexOf)</li>
<li>object: 它会检查你的’值’是否是该对象的一个​定义的属性</li>
</ul>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'odin'</span>, <span class="attr">weapons</span> : [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'thor'</span>, <span class="attr">weapons</span> : [<span class="string">'mjolnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'svafrlami'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'arngrim'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns 'svafrlami', 'arngrim', and 'thor' documents</span></span><br><span class="line">results = users.find(&#123; <span class="string">'weapons'</span> : &#123; <span class="string">'$containsAny'</span> : [<span class="string">'tyrfing'</span>, <span class="string">'mjolnir'</span>] &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$containsNone</strong> - 过滤具有不包含所提供的值的属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'odin'</span>, <span class="attr">weapons</span> : [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'thor'</span>, <span class="attr">weapons</span> : [<span class="string">'mjolnir'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'svafrlami'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line">users.insert(&#123; <span class="attr">name</span> : <span class="string">'arngrim'</span>, <span class="attr">weapons</span> : [<span class="string">'tyrfing'</span>]&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns 'svafrlami' and 'arngrim'</span></span><br><span class="line">results = users.find(&#123; <span class="string">'weapons'</span> : &#123; <span class="string">'$containsNone'</span> : [<span class="string">'gungnir'</span>, <span class="string">'mjolnir'</span>] &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$type</strong> - 过滤具有指定类型属性的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">users.insert([</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'odin'</span>, <span class="attr">weapons</span>: [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'thor'</span>, <span class="attr">weapons</span>: <span class="string">'mjolnir'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'svafrlami'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'arngrim'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回docs（非数组）字符串值为'weapons'（mjolnir）</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'weapons'</span> : &#123; <span class="string">'$type'</span> : <span class="string">'string'</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$finite</strong> - 过滤具有数字或非数字属性的文档。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回所有文档，其中isFinite（doc.age）=== true</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="attr">age</span>: &#123; <span class="attr">$finite</span>: <span class="literal">true</span> &#125;&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$size</strong> - 筛选具有指定大小的数组属性的文档。（不适用于字符串）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">users.insert([</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'odin'</span>, <span class="attr">weapons</span>: [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'thor'</span>, <span class="attr">weapons</span>: <span class="string">'mjolnir'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'svafrlami'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'arngrim'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回docs'weapons'是2个元素数组（odin）</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'weapons'</span> : &#123; <span class="string">'$size'</span> : <span class="number">2</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$len</strong> - 筛选具有指定长度的字符串属性的文档。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">users.insert([</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'odin'</span>, <span class="attr">weapons</span>: [<span class="string">'gungnir'</span>, <span class="string">'draupnir'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'thor'</span>, <span class="attr">weapons</span>: <span class="string">'mjolnir'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'svafrlami'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">'arngrim'</span>, <span class="attr">weapons</span>: [<span class="string">'tyrfing'</span>] &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns docs where 'name' is a 9 character string (svafrllami)</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="string">'name'</span> : &#123; <span class="string">'$len'</span> : <span class="number">9</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$and</strong> - 筛选符合所有嵌套子表达式的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取匹配两个子表达式的文档</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;</span><br><span class="line">  <span class="string">'$and'</span>: [&#123; </span><br><span class="line">      <span class="string">'age'</span> : &#123;</span><br><span class="line">        <span class="string">'$gt'</span>: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="string">'name'</span> : <span class="string">'Thor'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// alternative 'implicit' syntax :</span></span><br><span class="line">results = coll.find(&#123;</span><br><span class="line">  age: &#123; <span class="attr">$gt</span>: <span class="number">30</span> &#125;,</span><br><span class="line">  name: <span class="string">'Thor'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>$or</strong> - 筛选符合任何嵌套子表达式的文档</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取匹配任何子表达式的文档</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;</span><br><span class="line">  <span class="string">'$or'</span>: [&#123; </span><br><span class="line">      <span class="string">'age'</span> : &#123;</span><br><span class="line">        <span class="string">'$gte'</span>: <span class="string">'40'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="string">'name'</span> : <span class="string">'Thor'</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="支持“find”查询的功能"><a href="#支持“find”查询的功能" class="headerlink" title="支持“find”查询的功能"></a>支持“find”查询的功能</h3><p>这些<code>操作符</code>可用于组合查找过滤对象，可用于以下内容中：</p>
<ul>
<li>Collection find()</li>
<li>Collection findOne()</li>
<li>(chained) Resultset find()</li>
<li>Collection Transforms</li>
<li>DynamicView applyFind()</li>
</ul>
<h3 id="程序化查询示例"><a href="#程序化查询示例" class="headerlink" title="程序化查询示例"></a>程序化查询示例</h3><p>以下查询返回相同的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Core collection 'find' method</span></span><br><span class="line"><span class="keyword">var</span> results = coll.find(&#123;<span class="string">'Age'</span>: &#123;<span class="string">'$gte'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resultset chaining</span></span><br><span class="line">results = coll.chain().find(&#123;<span class="string">'Age'</span>: &#123;<span class="string">'$gte'</span>: <span class="number">40</span>&#125;&#125;).data();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Core collection 'where' method</span></span><br><span class="line">results = coll.where(<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> obj.Age &gt;= <span class="number">40</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Resultset-链"><a href="#Resultset-链" class="headerlink" title="Resultset 链"></a>Resultset 链</h3><p>核心<code>find</code>和<code>where</code>功能是<code>Resultset链</code>允许您构建的两个主要构建块。其他可用的方法包括：</p>
<ul>
<li>limit - 允许将结果集限制为指定数量的文档。</li>
<li>offset - 允许从结果集中跳过第一批数据文档。</li>
<li>branch - 用于将查询路径分成多个分支。</li>
<li>simplesort - 只需传递一个属性名称，你的<code>resulset</code>就会按这个排序。</li>
<li>sort - 允许您提供自己的<code>比较函数</code>来对结果集进行排序。</li>
<li>compoundsort - 允许您<code>根据多个属性按升序或降序</code>排序。</li>
<li>update - 用于对当前结果集中的所有文档运行更新操作（JavaScript函数）。</li>
<li>remove - 从集合中删除当前处于结果集中的所有文档对象（以及结果集）</li>
<li>map - 映射到一个新的匿名集合中，提供一个映射函数</li>
<li>mapReduce - 允许您在当前结果集数据上指定map函数和reduce函数。</li>
<li>eqJoin - 左连接两组数据。连接键可以被定义或计算属性</li>
<li>transform - 在结果集级别，这需要一个原始转换数组。当开始一个链时，一个命名或原始的转换可能被传入链式方法。 (See the <a href="https://github.com/techfort/LokiJS/wiki/Collection-Transforms" target="_blank" rel="noopener">‘Collection Transforms’</a> wiki page for more details.)</li>
</ul>
<p>更好地使用<code>方法链</code>的例子可能如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> results = coll.chain()</span><br><span class="line">                  .find(&#123;<span class="string">'Age'</span>: &#123;<span class="string">'$gt'</span>:<span class="number">20</span>&#125;&#125;)</span><br><span class="line">                  .where(<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">                     <span class="keyword">return</span> obj.Country.indexOf(<span class="string">'FR'</span>) === <span class="number">0</span>;</span><br><span class="line">                   &#125;)</span><br><span class="line">                  .simplesort(<span class="string">'Name'</span>)</span><br><span class="line">                  .offset(<span class="number">100</span>)</span><br><span class="line">                  .limit(<span class="number">25</span>)</span><br><span class="line">                  .data();</span><br></pre></td></tr></table></figure>
<h3 id="结果集分支-Resultset-branching"><a href="#结果集分支-Resultset-branching" class="headerlink" title="结果集分支(Resultset branching)"></a>结果集分支(Resultset branching)</h3><p>结果集及其结果并不意味着被“持有”。这些情况通常涉及利用动态视图来保持结果最新。但是，只要您想在发生任何插入/更新/删除之前，立即使用结果集，您可以随时临时分支<code>Resulset</code>。动态视图还允许分支结果集，而结果集又取其内部的结果集，并使用此分支来允许您进一步查询和转换其结果，而不会受到已执行过的过滤器的初始化时的影响。</p>
<p>集合分支的一个简单示例，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> baseResulset = coll.chain().find(&#123;<span class="string">'Age'</span>: &#123;<span class="string">'$gte'</span>: <span class="number">40</span>&#125;&#125;);</span><br><span class="line"><span class="keyword">var</span> branchedResulset = baseResultset.branch();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> usResults = baseResultset.find(&#123;<span class="string">'Country'</span>: <span class="string">'US'</span>&#125;).data();</span><br><span class="line"><span class="keyword">var</span> ieResults = branchedResulset.find(&#123;<span class="string">'Country'</span>: <span class="string">'IE'</span>&#125;).data();</span><br></pre></td></tr></table></figure>
<p>如果基础查询耗费时间，则您的后续分支无需承担该通用成本，这样做的好处是。在大型集合或对时间敏感的应用程序中，分支通常更有用。</p>
<p>如果您需要检查链中各个阶段的<code>data()</code>或文档计数，则可以保留结果集（即使未分支时）以将链分成几个部分。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>尽可能在’Where’查询之前使用’Find’查询。</strong>如果它们被应用并与您的查询有关，则<strong>“Find”查询能够使用索引</strong>。</p>
<p><strong>核心（Collection）的查询方法（<code>Collection.where(), Collection.find(), Collection.findOne(), Collection.by()</code>）是学习<code>lokijs</code>的最佳方法。对于许多应用程序来说，这可能足以满足您的查询需求。</strong>不可用的功能(尚未提供)是排序(sorting)，限制(limiting)，偏移(offsets)和其他更高级别的转换。</p>
<hr>
<p><strong>链查询通过调用<code>collection.chain()</code>方法返回的<code>Resultset</code>类来完成。</strong></p>
<p>这样做，为我们的查询建立一个<code>state</code>。您可以将多个<code>查找(find)</code>，<code>过滤(where)</code>，<code>排序(sorts)</code>，<code>限制(limit)</code>，<code>偏移(offset)</code>等操作串在一起，逐步过滤和转换结果。</p>
<p>您也可以建立查询分支，尽可能高效地将查询分解为多个方向。通过结果集进行<code>链调用</code>仍然用于即时评估。</p>
<p>如果您将结果集保留在内存中，则不保证底层数据发生更改时保持最新状态。</p>
<p>只有第一个链的操作可能会使用数据库过滤器，因此优先考虑最昂贵的<code>find()</code>过滤器（其中应用了索引）作为第一个链接操作。</p>
<hr>
<p><strong>通过<code>链变换</code>允许在对象中定义与方法链相同的功能，其功能类似于<code>存储过程</code>。</strong></p>
<p>由于它是对象表示，因此可以（可选）命名并与数据库一起保存。此方法也用于即时评估。</p>
<hr>
<p><strong><code>DynamicViews</code>旨在让<code>fresh</code>的数据库视图随时可用。</strong></p>
<p>您可以应用<code>find</code>和<code>where</code>过滤器，并指定排序。</p>
<p><u>随着文档的插入，更新或删除，您查看的内容将立即保持最新状态。</u></p>
<p>这可以确保您的视图具有最佳的读取性能，因为它始终处于最新状态。</p>
<p>如果您的视图需要进一步过滤，则可以将结果集从其中分离出来。</p>
<p>在分支<code>DynamicView</code>的时候，您可以在该时刻捕获<code>DynamicView</code>内部结果集的快照，从而可以执行各种各样的链接操作以进行即时评估。</p>
<p>因此，如果您执行<code>DynamicView</code>分支，请将视图视为保证<code>fresh</code>，并将分支视为快速一次性分支进行评估。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs2_index_query/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs2_index_query/" itemprop="url">
                  索引和查询性能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs2_index_query/" class="leancloud_visitors" data-flag-title="索引和查询性能">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Loki.js</code>一直是快速的内存数据库解决方案。事实上，最近的基准测试表明，在<code>node.js</code>下运行的终端<code>Core i5</code>中，其主要的<code>get()</code>操作速度约为每秒140万次。<code>get()</code> 操作利用一个自动生成的 <code>&#39;$loki</code> id 列和自己生成的二进制索引。如果您希望提供您自己的<code>unique key</code>，则可以添加单个唯一的索引到集合中，便可使用<code>collection.by()</code>方法进行获取。这种方法比使用内置的<code>$loki</code>  id快得多。因此，如果您打算进行单一对象查找，就可以获得此优化的性能。</p>
<h3 id="使用自动生成的-loki列查找示例"><a href="#使用自动生成的-loki列查找示例" class="headerlink" title="使用自动生成的$loki列查找示例 :"></a>使用自动生成的<code>$loki</code>列查找示例 :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = db.addCollection(<span class="string">"users"</span>);</span><br><span class="line"><span class="keyword">var</span> resultObj = users.insert(&#123;<span class="attr">username</span>:<span class="string">"Heimdallr"</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在我们的对象已经被插入，它将会添加一个`$loki`属性</span></span><br><span class="line"><span class="keyword">var</span> heimdallr = users.get(resultObj.$loki);</span><br></pre></td></tr></table></figure>
<h3 id="示例对象查找指定您自己的唯一索引"><a href="#示例对象查找指定您自己的唯一索引" class="headerlink" title="示例对象查找指定您自己的唯一索引 :"></a>示例对象查找指定您自己的唯一索引 :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = db.addCollection(<span class="string">"users"</span>, &#123;</span><br><span class="line">    unique: [<span class="string">'username'</span>]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入记录后，您可能会使用coll.by()检索记录</span></span><br><span class="line"><span class="keyword">var</span> result = users.by(<span class="string">"username"</span>, <span class="string">"Heimdallr"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="‘Find’-过滤"><a href="#‘Find’-过滤" class="headerlink" title="‘Find’ 过滤"></a>‘Find’ 过滤</h3><p>更通用的查询方式是使用接受<code>mongo</code>风格查询对象的<code>collection.find()</code>。如果您没有为正在搜索的列添加索引，可以在<code>node.js</code>下获得预期约 <code>20k ops/sec</code> (浏览器性能可能会有所不同，但这是一个很好的数量级)。对于大多数情况下，性能可能比需要的更高，但现在可以在对象属性上应用<code>loki.js</code>二进制索引。使用<code>collection.ensureIndex(propertyName)</code>方法，您可以创建一个可以被各种<code>find()</code>操作使用的索引，例如<code>collection.find()</code>。对于我们的测试基准，这会将性能提高到大约<code>500k ops/sec</code>。</p>
<p>二进制索引可以与范围操作符一起使用，返回给定<code>属性/范围</code>的多个文档结果。<strong>如果您已将二进制索引应用于属性，则可以通过使用包含该属性的查询对象调用<code>collection.find()</code>来利用该索引。</strong>能够使用二进制索引的<code>find()</code>操作符包括<code>$eq, $aeq, $lt, $lte, $gt, $gte, $between, $in.</code></p>
<blockquote>
<p>默认情况下，如果您在属性上应用了二进制索引，并且将包含JavaScript Date对象的文档作为该属性的值插入，则 <code>loki</code> 将用可序列化安全的历元时间格式日期（整数）替换它。这是为了防止索引变得不可维护，如果我们将它保存为Date并将其作为字符串加载（它们就可以不同的顺序排序）。如果你不打算保存你的数据库（完全在内存中使用），你可以在创建集合时传递一个<code>&#39;serializableIndices：false&#39;</code>选项，我们不会改变你的日期。</p>
</blockquote>
<h3 id="二进制索引示例"><a href="#二进制索引示例" class="headerlink" title="二进制索引示例 :"></a>二进制索引示例 :</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> coll = db.addCollection(<span class="string">'users'</span>, &#123;</span><br><span class="line">  indices: [<span class="string">'location'</span>]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入记录后，您可以使用相等或范围操作符,如这种隐式 (strict) $eq op :</span></span><br><span class="line"><span class="keyword">var</span> results = users.find(&#123; <span class="attr">location</span>:  <span class="string">'Himinbjörg'</span> &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Loki-的排序和范围"><a href="#Loki-的排序和范围" class="headerlink" title="Loki 的排序和范围"></a>Loki 的排序和范围</h3><blockquote>
<p>Native JavaScript提供 <code>==</code>（abstract）相等，<code>===</code>（strict）相等，<code>&lt;</code>（abstract）小于，<code>&gt;</code>（abstract）大于等等。JavaScript处理很多混合类型，所以你可能想要一个数字4（abstract）等于字符串’4’。如果你想测试’小于’4，它会默认转换为字符串，所以如果你不想要字符串，你将不得不使用<code>&#39;typeof&#39;</code>或其他类型检测来手动过滤掉其他类型。Loki倾向于处理纯数据，但必须动态变化以支持额外发现的各种“脏”数据。因此，我们试图调整“范围”的概念，因为它涉及属性上的混合类型，以便它们适应混合类型，并提供类似的<code>find()</code>结果，而不管您是否使用二进制索引。</p>
</blockquote>
<ul>
<li><code>loki</code>中的所有值都被我们的<code>find()</code>操作解释为“小于”，“大于” 或 “等于” 任何其他值。这与JavaScript不同，所以<code>loki</code>在两个值之间建立了统一的范围排序。</li>
<li>4 是 <code>$aeq</code> (非严格等于) <code>&#39;4&#39;</code>, 正如 <code>&#39;3&#39; $lt(小于) 4</code>, 和 <code>4 is $gte(大于) &#39;3&#39;</code>, 所以混合数字和’数字’字符串范围在<code>loki</code>中查找数字。</li>
<li>‘数字’字符串与’非数字’字符串保持在不同的范围（数字），所以<code>9999</code>将会是<code>$lt &#39;111asdf&quot;</code>。</li>
<li>对象都是平等的（除非使用点符号来查询对象属性）。</li>
<li>日期按照他们的纪元时间排序为数字……这些数字很大，一般在数字范围的顶端。</li>
<li><code>$type op</code>可用于过滤不符合特定<code>JavaScript</code>类型的结果。</li>
<li><code>$finite op</code> 可用于过滤出“数字”或“非数字”的结果。</li>
</ul>
<h3 id="‘Where’-过滤器"><a href="#‘Where’-过滤器" class="headerlink" title="‘Where’ 过滤器"></a>‘Where’ 过滤器</h3><p><strong>如果性能受到关注，应该谨慎使用’Where’过滤器（JavaScript过滤器函数）。他们无法使用索引，因此性能不会比未索引查找更好，并且取决于过滤器函数的复杂性，甚至更少。</strong>Unindex查询以及过滤器始终需要完整阵列扫描的位置，但如果数千ops/sec足够用，或稍后在查询链或动态视图过滤器管道中使用，并且惩罚更少，则它们可能非常有用。</p>
<h3 id="在查询链中进行索引"><a href="#在查询链中进行索引" class="headerlink" title="在查询链中进行索引"></a>在查询链中进行索引</h3><p><code>Resultset</code>类引入了<code>方法链</code>作为查询选项。您可以使用<code>方法链</code>来连续应用几个查找操作，或者将<code>find()</code>，<code>where()</code>和<code>sort()</code>操作混合到<code>顺序链式</code>管道中。为了简单起见，这个例子可能是（其中用户是一个集合对象）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">users.chain().find(queryObj).where(queryFunc).simplesort(&apos;name&apos;).data();</span><br></pre></td></tr></table></figure>
<p>检查这个语句，如果<code>queryObj</code>（一个mongo风格的查询对象）是<code>{&#39;age&#39;：{&#39;$ gt&#39;：30}}</code>，那么这个年龄段列表最好应用一个索引，并且<code>find()</code>链操作应该在<code>方法链</code>中排名第一。<strong>在链式操作中，只有第一个链式过滤器可以利用索引进行过滤。</strong>如果它筛选出足够数量的记录，那么（where）查询函数的影响会更小。保留过滤结果集的开销比<code>collection.find</code>降低了20％左右，但是它们的功能更强大。在我们的基准测试中，这仍然大约是 <strong>400k  ops/sec</strong>。</p>
<h3 id="索引和排序"><a href="#索引和排序" class="headerlink" title="索引和排序"></a>索引和排序</h3><p>如果没有应用过滤器，并且（例如）’name’属性上存在二进制索引，则可以充分利用二进制索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coll.chain().simplesort(&apos;name&apos;).data();</span><br></pre></td></tr></table></figure>
<p>如果发生了过滤，我们将检测我们是否可以利用<code>&#39;索引相交&#39;</code>算法中的索引来加速对典型<code>loki</code>排序的排序。只有在结果集中的结果集总数超过10％的情况下，才会启用此’索引相交’算法，否则标准loki排序将被确定为更快的方法。“索引相交”的性能优势与过滤质量有些成反比，因此它利用二进制索引来帮助减少“最坏情况”的分类处罚。</p>
<p><strong><code>Loki sorting</code> 不仅用于排序，还用于构建二进制索引</strong>，但如果您不需要在混合类型中进行更加统一的排序，则可以通过调用以下方法将额外的毫秒数排除在排序调用之外：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coll.chain().simplesort(&apos;name&apos;, &#123; useJavascriptSorting: true &#125;).data();</span><br></pre></td></tr></table></figure>
<p>如果在<code>&#39;name&#39;</code>属性中存在二进制索引，我们将使用索引相交算法，除非<code>resultset</code>具有10％或更少的文档总数，此时我们将回退到传递给<code>simplesort</code>的属性上的JavaScript排序。如果您没有在该属性上应用二进制索引，那么如果该选项已通过，我们将始终使用JavaScript排序。</p>
<h2 id="动态视图管道"><a href="#动态视图管道" class="headerlink" title="动态视图管道"></a>动态视图管道</h2><p>动态视图的行为与结果集[resultsets]相似，因为您要使用索引，必须使用第一个过滤器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userview = users.addDynamicView(<span class="string">"over30"</span>);</span><br><span class="line">userview.applyFind(&#123;<span class="string">'Age'</span>: &#123;<span class="string">'$gte'</span>:<span class="number">30</span>&#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以随时获取最新的视图结果</span></span><br><span class="line"><span class="keyword">var</span> results = userview.data();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或对结果集进一步过滤</span></span><br><span class="line">results = userview.branchResultset().find(&#123;<span class="string">'Country'</span>: <span class="string">'JP'</span>&#125;).data();</span><br></pre></td></tr></table></figure>
<p>该查找过滤器理想情况下应引用您已应用索引（在此情况下为“年龄”）的字段。但是，动态视图运行一次它们的过滤器，因此即使是非高性能查询管道在建立之后也是快速的。这是由于在插入，更新或从集合中删除单个对象时重新评估这些过滤器。作为单个对象评估，在第一次评估期间不存在阵列扫描损失。动态视图的开销占据了结果集的顶部，将第一次评估的性能降低了大约40％，但后续查询得到了高度优化（比collection.find更快）。即使有这样的开销，我们的基准测试显示初始评估大约为30万[ops/sec]性能。根据更新频率的不同，后续评估可以扩展至每秒100万次以上。</p>
<p>在<code>loki.js</code>中，动态视图目前有两个选项，<code>&#39;persistent&#39;（默认为false</code>）和<code>&#39;sortPriority&#39;（默认为&#39;passive&#39;）</code>。</p>
<p><code>&#39;persistent&#39;</code>选项表示结果将保存在内部数组中（除了正常的结果集）。这个<code>&#39;resultdata&#39;</code>数组会根据您的规范进行过滤和排序。将结果复制到内部数组发生在第一次<code>data()</code>评估期间，或者一旦过滤器或排序将结果集污染（文档插入，更新，从视图中删除）。此选项会增加内存开销，但可能会优化<code>data()</code>调用。</p>
<p><code>&#39;sortPriority&#39;</code>选项可以是<code>&#39;passive&#39;或&#39;active&#39;</code>。默认情况下，当调用<code>data()</code>并将这些排序标记污染时，会进行懒惰<code>（&#39;passive&#39;）</code>。如果您希望排序成本为<code>“up-front”</code>，您可以指定<code>“active” sortPriority</code>。使用<code>active</code>的<code>sortPriority</code>，一旦插入/更新/删除将排序标记为脏，我们将排队并限制异步排序以在线程产生时运行。因此，如果更新频率较低或单独批量修改，则可以预先支付性能成本，以确保稍后获得最佳<code>data()</code>检索速度。如果您的数据修改频繁且零星，如果没有人读取数据，则有效的<code>sortPriority</code>可能会浪费计算排序。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs1_overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs1_overview/" itemprop="url">
                  LokiJS快速入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs1_overview/" class="leancloud_visitors" data-flag-title="LokiJS快速入门">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://lokijs.org" target="_blank" rel="noopener">LokiJS.org web site</a><br><a href="https://github.com/techfort/LokiJS" target="_blank" rel="noopener">LokiJS GitHub page</a><br><a href="https://rawgit.com/techfort/LokiJS/master/examples/sandbox/LokiSandbox.htm" target="_blank" rel="noopener">Sandbox / Playground</a></p>
<h2 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h2><p>LokiJS是一个面向文档的JavaScript数据库，与MongoDB有些相似。这只是一个概述，有关完整的文档，请参阅 <a href="http://lokijs.org/" target="_blank" rel="noopener">lokijs.org</a>.</p>
<p>它支持数据集合的索引，查询和过滤。LokiJS还支持更高级的功能，例如<code>mapReduce</code>，事务，并允许您实现自定义远程同步以将数据保存到服务器（或移动设备上的本地文件）。持久化到磁盘已经为<code>CommonJS</code>环境（如<code>nodejs</code>）实现，在移动设备上，您只需要请求文件系统并将<code>lokijs</code>的<code>serialize()</code> 作为内容传递。</p>
<p>在浏览器或移动环境中，您只需要包含<code>build/lokijs.min.js</code></p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><h3 id="1-面向文档"><a href="#1-面向文档" class="headerlink" title="1. 面向文档"></a>1. 面向文档</h3><p>数据存储为JavaScript对象，并序列化为JSON以用于磁盘持久化。</p>
<h3 id="2-索引"><a href="#2-索引" class="headerlink" title="2. 索引"></a>2. 索引</h3><p>您可以指定索引以加快对某些对象属性的搜索。’id’字段自动编入索引，并使用二进制搜索算法来避免<code>for(;;)</code>循环变慢</p>
<h3 id="3-视图"><a href="#3-视图" class="headerlink" title="3. 视图"></a>3. 视图</h3><p>您可以声明自定义视图函数用以返回基于复杂逻辑的结果集。</p>
<h3 id="4-Map-reduce"><a href="#4-Map-reduce" class="headerlink" title="4. Map reduce"></a>4. Map reduce</h3><p>您可以声明<code>map</code>和<code>reduce</code>函数以检索数据库中的聚合数据。</p>
<h2 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h2><p>如果您在<code>node.js</code>环境中工作，请运行 <code>npm install lokijs</code> 并确保调用 <code>var loki = require(&#39;lokijs&#39;)</code></p>
<p>创建数据库:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db = <span class="keyword">new</span> loki(<span class="string">'Example'</span>);</span><br></pre></td></tr></table></figure>
<p>创建一个集合，指定名称，类型，索引字段以及集合是否是事务性的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = db.addCollection(<span class="string">'users'</span>, &#123; <span class="attr">indices</span>: [<span class="string">'email'</span>] &#125;);</span><br><span class="line"><span class="comment">// 请注意，索引可以是单个字符串或字符串数组</span></span><br></pre></td></tr></table></figure>
<p>请注意，索引和事务标志是可选参数。<code>LokiJS</code>中的事务只是允许您运行操作并自动将数据库恢复到事务开始之前的阶段（如果发生错误）。</p>
<p>在数据库中添加一些用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var odin = users.insert( &#123; name : &apos;odin&apos;, email: &apos;odin.soap@lokijs.org&apos;, age: 38 &#125; );</span><br><span class="line">var thor = users.insert( &#123; name : &apos;thor&apos;, email : &apos;thor.soap@lokijs.org&apos;, age: 25 &#125; );</span><br><span class="line">var stan = users.insert( &#123; name : &apos;stan&apos;, email : &apos;stan.soap@lokijs.org&apos;, age: 29 &#125; );</span><br><span class="line">var oliver = users.insert( &#123; name : &apos;oliver&apos;, email : &apos;oliver.soap@lokijs.org&apos;, age: 31 &#125; );</span><br><span class="line">var hector = users.insert( &#123; name : &apos;hector&apos;, email : &apos;hector.soap@lokijs.org&apos;, age: 15&#125; );</span><br><span class="line">var achilles = users.insert( &#123; name : &apos;achilles&apos;, email : &apos;achilles.soap@lokijs.org&apos;, age: 31 &#125; );</span><br></pre></td></tr></table></figure>
<p>操作更新：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stan.name = &apos;Stan Laurel&apos;;</span><br><span class="line">// 更新对象（这实际上只是同步索引）</span><br><span class="line">users.update(stan);</span><br></pre></td></tr></table></figure>
<p>动态视图 (DynamicViews) - 推荐方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var dv = users.addDynamicView(&apos;a_complex_view&apos;);</span><br><span class="line">dv.applyWhere(function aCustomFilter(obj)&#123;</span><br><span class="line">  return obj.name.length  &lt; 5 &amp;&amp; obj.age &gt; 30;</span><br><span class="line">&#125;);</span><br><span class="line">// 查看数据</span><br><span class="line">console.log(dv.data());</span><br><span class="line"></span><br><span class="line">// 应用一些更改</span><br><span class="line">users.insert(&#123; name: &apos;ratatosk&apos;, email: &apos;rata@tosk.r&apos;, age: 10320 &#125;);</span><br><span class="line"></span><br><span class="line">// 看看动态视图通过检查数据来更新自己</span><br><span class="line">console.log(dv.data());</span><br></pre></td></tr></table></figure>
<p>‘Where’ 过滤函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function ageView(obj)&#123;</span><br><span class="line">  return obj.age &gt; 30;</span><br><span class="line">&#125;</span><br><span class="line">// 更复杂一些，名字长于3个字符，年龄超过30岁的用户</span><br><span class="line">function aCustomFilter(obj)&#123;</span><br><span class="line">  return obj.name.length  &lt; 5 &amp;&amp; obj.age &gt; 30;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//测试过滤器</span><br><span class="line">var result = users.where(ageView);</span><br><span class="line">var anotherResult = users.where(aCustomFilter);</span><br></pre></td></tr></table></figure>
<p>Map Reduce (实时演示示例在 <a href="http://lokijs.org/#/demo" target="_blank" rel="noopener">lokijs.org</a> 上):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function getDuration( obj )&#123;</span><br><span class="line">  return obj.complete ? null : obj.duration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getAverage( array )&#123;</span><br><span class="line">  var cumulator = 0;</span><br><span class="line">  var i = array.length &gt;&gt;&gt; 0;</span><br><span class="line">  var actual = 0;</span><br><span class="line">  while(i--)&#123;</span><br><span class="line">    if(array[i] != null)&#123;</span><br><span class="line">      cumulator += array[i];</span><br><span class="line">      actual++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return ( cumulator / actual).toFixed(2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var avgDuration = todos.mapReduce( getDuration, getAverage );</span><br></pre></td></tr></table></figure>
<p>通过方法链查询 :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">users.chain()</span><br><span class="line">  .find(&#123;&apos;age&apos;:&#123;&apos;$gt&apos;: 25&#125;&#125;)</span><br><span class="line">  .where(function(obj)&#123; return obj.name.indexOf(&quot;in&quot;) != -1 &#125;)</span><br><span class="line">  .simplesort(&quot;age&quot;)</span><br><span class="line">  .offset(50)</span><br><span class="line">  .limit(10)</span><br><span class="line">  .data()</span><br></pre></td></tr></table></figure>
<p>简单的命名变换 :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">users.addTransform(&apos;progeny&apos;, [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;find&apos;,</span><br><span class="line">    value: &#123;</span><br><span class="line">      &apos;age&apos;: &#123;&apos;$lte&apos;: 40&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;simplesort&apos;,</span><br><span class="line">    property: &apos;age&apos;,</span><br><span class="line">    desc: true</span><br><span class="line">  &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">var results = users.chain(&apos;progeny&apos;).data();</span><br></pre></td></tr></table></figure>
<p>更多信息:</p>
<ul>
<li>访问 : <a href="http://www.lokijs.org/" target="_blank" rel="noopener">www.lokijs.org</a></li>
<li>示例 : <a href="https://github.com/techfort/LokiJS/tree/master/examples" target="_blank" rel="noopener">https://github.com/techfort/LokiJS/tree/master/examples</a></li>
<li>StackOverflow : <a href="https://stackoverflow.com/questions/tagged/lokijs" target="_blank" rel="noopener">https://stackoverflow.com/questions/tagged/lokijs</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs7_autoupdating_collections/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs7_autoupdating_collections/" itemprop="url">
                  自动更新集合
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs7_autoupdating_collections/" class="leancloud_visitors" data-flag-title="自动更新集合">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="集合的自动更新功能"><a href="#集合的自动更新功能" class="headerlink" title="集合的自动更新功能"></a>集合的自动更新功能</h1><p>可以通过构造函数选项<code>autoupdate：true</code>在每个集合的基础上启用自动更新。该功能需要<code>Object.observe</code>（目前在<code>Chrome 36+</code>, <code>io.js</code> 和 <code>Node.js 0.12+</code>中实现）。如果观察者不可用，则该选项将被忽略。</p>
<p>无论何时修改文档，自动更新(<code>Autoupdate</code>)都会自动调用 <code>update(doc)</code>，这对索引更新和脏标记（用于确定数据库是否已被修改并应该保留）是必需的。</p>
<p>启用此功能基本上意味着，所有手动<code>update</code>呼叫都可以省略。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> doc = collection.by(<span class="string">"name"</span>, <span class="string">"John"</span>);</span><br><span class="line"></span><br><span class="line">doc.name = <span class="string">"Peter"</span>;</span><br><span class="line">doc.age = <span class="number">32</span>;</span><br><span class="line">doc.gender = <span class="string">"male"</span>;</span><br><span class="line"></span><br><span class="line">collection.update(doc); <span class="comment">// 这行代码可以安全地删除。</span></span><br></pre></td></tr></table></figure>
<p>自动更新(<code>Autoupdate</code>)将在当前事件循环结束时调用 <code>update</code> ，因此即使在进行多项更改时也只会调用 <code>update</code> 一次。</p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>自动更新和手动更新之间有一个重要区别。例如，如果文档更改违反了唯一键约束，<code>update</code>将同步抛出一个可以同步捕获的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var collection = db.addCollection(&quot;test&quot;, &#123;</span><br><span class="line">  unique: [&quot;name&quot;]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">collection.insert(&#123; name: &quot;Peter&quot; &#125;);</span><br><span class="line"></span><br><span class="line">var doc = collection.insert(&#123; name: &quot;Jack&quot; &#125;);</span><br><span class="line">doc.name = &quot;Peter&quot;;</span><br><span class="line"></span><br><span class="line">try &#123;</span><br><span class="line">  collection.update(doc);</span><br><span class="line">&#125; catch(err) &#123;</span><br><span class="line">  doc.name = &quot;Jack&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于自动更新(<code>Autoupdate</code>)异步调用更新，因此无法通过<code>try-catch</code>捕获错误。相反，你必须使用事件监听器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var collection = db.addCollection(&quot;test&quot;, &#123;</span><br><span class="line">  unique: [&quot;name&quot;],</span><br><span class="line">  autoupdate: true</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">collection.insert(&#123; name: &quot;Peter&quot; &#125;);</span><br><span class="line"></span><br><span class="line">var doc = collection.insert(&#123; name: &quot;Jack&quot; &#125;);</span><br><span class="line">doc.name = &quot;Peter&quot;;</span><br><span class="line"></span><br><span class="line">collection.on(&quot;error&quot;, function(errDoc) &#123;</span><br><span class="line">  if(errDoc === doc) &#123;</span><br><span class="line">    doc.name = &quot;Jack&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这可能会变得非常繁琐，因此您应该考虑在更新文档之前进行检查。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.lijunbo.com/2018/05/02/lokijs6_collection_transforms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="William-Dream">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静水流深">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/lokijs6_collection_transforms/" itemprop="url">
                  集合变换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T09:12:51+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/02/lokijs6_collection_transforms/" class="leancloud_visitors" data-flag-title="集合变换">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="集合变换"><a href="#集合变换" class="headerlink" title="集合变换"></a>集合变换</h2><hr>
<p><strong>集换背后的基本思想是允许将结果集的“链”式调用过程转换为该过程的对象定义。这个数据定义可以随意命名，并与集合一起保存在数据库中。</strong></p>
<p>这可能对以下方面有用：</p>
<ul>
<li>编写在loki数据库上运行的工具</li>
<li>创建’存储过程’的命名查询</li>
<li>转换您的数据以便提取</li>
<li>可以通过自定义<code>meta</code>进行扩展</li>
</ul>
<p>变换是在集合链上执行的(有序)“步骤(step)”对象数组。这些步骤可能包括以下类型：</p>
<ul>
<li>‘find’</li>
<li>‘where’</li>
<li>‘simplesort’</li>
<li>‘compoundsort’</li>
<li>‘sort’</li>
<li>‘limit’</li>
<li>‘offset’</li>
<li>‘update’</li>
<li>‘remove’</li>
<li>‘map’</li>
<li>‘mapReduce’</li>
<li>‘eqJoin’</li>
</ul>
<p>这些转换步骤可以硬编码它们的参数，或者为<code>loki变换</code>添加参数替换机制。</p>
<p>一个简单的示例，只有一个步骤的<code>loki变换</code>可能如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var tx = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;find&apos;,</span><br><span class="line">    value: &#123;</span><br><span class="line">      &apos;owner&apos;: &apos;odin&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>然后可以使用以下命令将其选择性地保存到集合中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userCollection.addTransform(&apos;OwnerFilter&apos;, tx);</span><br></pre></td></tr></table></figure>
<p>这种转换可以通过以下任一方式执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userCollection.chain(&apos;OwnerFilter&apos;).data();</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userCollection.chain(tx).data();</span><br></pre></td></tr></table></figure>
<p>参数化在任何对象属性的右侧的值上得到处理，该值在变换中表示为以<code>&#39;[％lktxp]&#39;</code>开头的字符串。示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var tx = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;find&apos;,</span><br><span class="line">    value: &#123;</span><br><span class="line">      &apos;owner&apos;: &apos;[%lktxp]OwnerName&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>要执行此链式调用，您需要在执行时传递包含该参数值的参数对象。一个例子可能是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var params = &#123;</span><br><span class="line">  OwnerName: &apos;odin&apos;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">userCollection.chain(tx, params).data();</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userCollection.chain(&quot;OwnerFilter&quot;, params).data();</span><br></pre></td></tr></table></figure>
<p><strong>过滤功能无法保存到数据库中</strong>，但是如果您仍然需要它们，可以利用<code>转换和参数化</code>可以实现清晰的结构化并且可以执行保存的转换。一个例子可能是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var tx = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;where&apos;,</span><br><span class="line">    value: &apos;[%lktxp]NameFilter&apos;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">items.addTransform(&apos;ByFilteredName&apos;, tx);</span><br><span class="line"></span><br><span class="line">// 那么可能会立即发生以下情况，甚至可能在`保存/加载`周期中发生</span><br><span class="line">// 这个例子使用匿名函数，但也可以将其命名为函数引用</span><br><span class="line">var params = &#123;</span><br><span class="line">  NameFilter: function(obj) &#123;</span><br><span class="line">    return (obj.name.indexOf(&quot;nir&quot;) !== -1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var results = items.chain(&quot;ByFilteredName&quot;, params).data();</span><br></pre></td></tr></table></figure>
<p>转换可以包含多个要连续执行的步骤。在幕后，链命令将实例化一个<code>Resultset</code>并将其作为独立的链操作调用，最终在完成时返回结果。一些内置的“步骤(step)”，如<code>&#39;mapReduce&#39;</code>实际上通过返回一个数据数组来终止变换/链(transform/chain)，所以在这些情况下，<code>chain()</code>结果就是实际的数据，而不是你需要调用<code>data()</code>获取结果集。</p>
<p>更复杂的转换示例可能如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var tx = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;find&apos;,</span><br><span class="line">    value: &#123;</span><br><span class="line">      owner: &#123;</span><br><span class="line">        &apos;$eq&apos;: &apos;[%lktxp]customOwner&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;where&apos;,</span><br><span class="line">    value: &apos;[%lktxp]customFilter&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;limit&apos;,</span><br><span class="line">    value: &apos;[%lktxp]customLimit&apos;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">function myFilter(obj) &#123;</span><br><span class="line">  return (obj.name.indexOf(&quot;nir&quot;) !== -1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var params = &#123;</span><br><span class="line">  customOwner: &apos;odin&apos;,</span><br><span class="line">  customFilter: myFilter,</span><br><span class="line">  customLimit: 100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">users.chain(tx, params);</span><br></pre></td></tr></table></figure>
<p>如上例所示，我们将扫描对象层次结构（深达10层），并对右边的参数进行参数替换，这些值看起来是参数，然后我们将尝试从您的参数对象中查找。参数替换将用与您的<code>params</code>中包含的值相同的值替换该字符串，该参数可以是任何数据类型。</p>
<p>某些具有多个参数的步骤需要特定的步骤属性（除了类型和值）。这些在下面被演示为单独的步骤，这些步骤在单个变换中不一定有意义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">var step1 = &#123;</span><br><span class="line">  type: &apos;simplesort&apos;,</span><br><span class="line">  property: &apos;name&apos;,</span><br><span class="line">  desc: true</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var step2 = &#123;</span><br><span class="line">  type: &apos;mapReduce&apos;,</span><br><span class="line">  mapFunction: myMap,</span><br><span class="line">  reduceFunction: myReduce</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var step3 = &#123;</span><br><span class="line">  type: &apos;eqJoin&apos;,</span><br><span class="line">  joinData: jd,</span><br><span class="line">  leftJoinKey: ljk,</span><br><span class="line">  rightJoinKey: rjk,</span><br><span class="line">  mapFun: myMapFun</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var step4 = &#123;</span><br><span class="line">  type: &apos;remove&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="支持-DynamicViews"><a href="#支持-DynamicViews" class="headerlink" title="支持 DynamicViews"></a>支持 DynamicViews</h2><p>您现在可以使用转换作为<code>DynamicView</code>的提取方法。某些应用程序可能会使用它创建一个包含广泛结果集的<code>DynamicView</code>，这些结果可以从用户定义的转换中快速提取。此功能在<code>DynamicView</code>的<code>branchResultset()</code>方法中提供。它可以接受存储在集合级别的原始转换或命名转换。</p>
<p>一个例子可能如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var db = new loki(&apos;test&apos;);</span><br><span class="line">var coll = db.addCollection(&apos;mydocs&apos;);</span><br><span class="line">var dv = coll.addDynamicView(&apos;myview&apos;);</span><br><span class="line">var tx = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;offset&apos;,</span><br><span class="line">    value: &apos;[%lktxp]pageStart&apos;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    type: &apos;limit&apos;,</span><br><span class="line">    value: &apos;[%lktxp]pageSize&apos;</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line">coll.addTransform(&apos;viewPaging&apos;, tx);</span><br><span class="line"></span><br><span class="line">// add some records</span><br><span class="line"></span><br><span class="line">var results = dv.branchResultset(&apos;viewPaging&apos;, &#123; pageStart: 10, pageSize: 10 &#125;).data();</span><br></pre></td></tr></table></figure>
<p>重要的区别在于分支（以及因此您的转换结果）仅反映了您分支时的视图。这些转换是提取而不是内部用于视图。</p>
<h2 id="为定制解决方案添加元数据"><a href="#为定制解决方案添加元数据" class="headerlink" title="为定制解决方案添加元数据"></a>为定制解决方案添加元数据</h2><p>一种用于转换的用途可能是在用户界面构建，管理和执行这些转换时使用用户驱动的解决方案。在这种情况下，您可能需要将自己的元数据添加到变换中以进一步描述变换，步骤或参数。</p>
<ul>
<li>任何具有<code>Loki变换</code>未知类型的步骤都将被忽略。您可能会决定始终将第一步作为具有包含有关作者，描述或所需参数描述元数据信息的属性的“元”类型。</li>
<li>每个步骤还可以包含额外的属性，超出了我们所定义的要求，因此您可能会在步骤中嵌入步骤描述，上次更改的日期等。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Loki转换可以建立一个自动化数据转换的过程（只需很少的额外占用空间）。这不是必需的功能，也不是要取代方法链接，但它允许您抽象和组织重复的查询以实现清洁或动态目的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://www.gravatar.com/avatar/c8b98e5df395f0e0fd3b47948b37b881.jpg?s=215"
               alt="William-Dream" />
          <p class="site-author-name" itemprop="name">William-Dream</p>
           
              <p class="site-description motion-element" itemprop="description">为了梦-追梦,我的英文名由此而来</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/li-jun-bo" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.lijunbo.com/" title="Net" target="_blank">Net</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">William-Dream</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("PWTRJaGA9VmnmuJISstgYQVk-gzGzoHsz", "OhMVXOeW5jbdIohUayYbpq1v");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

</body>
</html>
